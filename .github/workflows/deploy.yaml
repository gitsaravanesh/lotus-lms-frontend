name: Deploy Frontend to S3

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build and Deploy React App to S3
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ap-south-1
      S3_BUCKET_NAME: lms-frontend-dev-fceacbe3   # ğŸ‘ˆ replace with your actual bucket name

    steps:
      # ğŸª£ Step 1 â€” Checkout Code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # âš™ï¸ Step 2 â€” Setup Node Environment
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      # ğŸ“¦ Step 3 â€” Install Dependencies
      # Use `npm ci` if lockfile exists; fallback to `npm install` if not
      - name: Install Dependencies
        run: |
          if [ -f package-lock.json ]; then
            echo "Lockfile found â€” using npm ci"
            npm ci
          else
            echo "No lockfile found â€” running npm install and generating one"
            npm install --package-lock-only
            npm ci
          fi

      # ğŸ—ï¸ Step 4 â€” Build React App
      - name: Build React App
        run: npm run build

      # ğŸ” Step 5 â€” Verify Build Folder Exists
      - name: Check Build Folder
        run: |
          if [ ! -d "./build" ]; then
            echo "âŒ Build folder not found!"
            exit 1
          fi

      # â˜ï¸ Step 6 â€” Deploy to S3
      - name: Deploy to S3
        run: |
          echo "Deploying to S3 bucket: $S3_BUCKET_NAME"
          aws s3 sync ./build s3://$S3_BUCKET_NAME --delete --cache-control max-age=86400

      # ğŸŒ Step 7 â€” Output S3 Website URL
      - name: Print Website URL
        run: |
          echo "âœ… Deployment complete!"
          echo "Visit your site at:"
          echo "http://$S3_BUCKET_NAME.s3-website.$AWS_REGION.amazonaws.com"